apiVersion: batch/v1
kind: CronJob
metadata:
  name: notif-db-reconcile-submitted
spec:
  # Production-friendly: frequent enough to heal, not so frequent it churns.
  schedule: "*/5 * * * *"
  startingDeadlineSeconds: 60
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 1
      ttlSecondsAfterFinished: 3600
      template:
        spec:
          restartPolicy: Never
          terminationGracePeriodSeconds: 10
          activeDeadlineSeconds: 300
          containers:
            - name: reconcile
              image: postgres:17-alpine
              imagePullPolicy: IfNotPresent
              command: ["/bin/sh", "-ec"]
              args:
                - |
                  test -n "${DB_DSN:-}" || { echo "DB_DSN is required"; exit 1; }
                  psql "$DB_DSN" -v ON_ERROR_STOP=1 \
                    -c "SET statement_timeout='2min'; SET lock_timeout='5s';" \
                    -f /sql/reconcile-submitted.sql
              envFrom:
                - secretRef:
                    name: notif-secrets
              resources:
                requests:
                  cpu: "50m"
                  memory: "128Mi"
                limits:
                  cpu: "200m"
                  memory: "256Mi"
              volumeMounts:
                - name: sql
                  mountPath: /sql
                  readOnly: true
          volumes:
            - name: sql
              configMap:
                name: notif-db-sql
