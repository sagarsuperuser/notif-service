apiVersion: apps/v1
kind: Deployment
metadata:
  name: notif-mock-provider
spec:
  replicas: 2
  revisionHistoryLimit: 5
  selector:
    matchLabels:
      app: notif-mock-provider
  template:
    metadata:
      labels:
        app: notif-mock-provider
    spec:
      terminationGracePeriodSeconds: 10
      nodeSelector:
        workload: mock-provider
      tolerations:
        - key: "workload"
          operator: "Equal"
          value: "mock-provider"
          effect: "NoSchedule"
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: notif-mock-provider
              topologyKey: kubernetes.io/hostname
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: notif-mock-provider
      containers:
        - name: mock-provider
          image: notif-mock-provider:dev
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          envFrom:
            - configMapRef:
                name: notif-config
            - secretRef:
                name: notif-secrets
          env:
            - name: PORT
              value: "8080"
            - name: MOCK_OUTCOME_MODE
              value: "weighted"
            - name: MOCK_OUTCOMES
              value: "ok"
            - name: MOCK_SUCCESS_RATE
              value: "0.98"
            - name: MOCK_FAILURE_TYPES
              value: "undelivered,failed,rate_limit,bad_request,server_error,timeout"
            - name: MOCK_FAILURE_WEIGHTS
              value: "undelivered:2,failed:3,rate_limit:4,bad_request:1,server_error:1,timeout:1"
            - name: MOCK_WEBHOOK_URL
              value: "http://notif-webhook-svc/v1/webhooks/twilio/status"
            # More realistic webhook timing: queued -> sent -> final, with jitter.
            - name: MOCK_WEBHOOK_QUEUE_DELAY_MS_MIN
              value: "50"
            - name: MOCK_WEBHOOK_QUEUE_DELAY_MS_MAX
              value: "300"
            - name: MOCK_WEBHOOK_SENT_DELAY_MS_MIN
              value: "200"
            - name: MOCK_WEBHOOK_SENT_DELAY_MS_MAX
              value: "1500"
            - name: MOCK_WEBHOOK_DELAY_MS_MIN
              value: "1000"
            - name: MOCK_WEBHOOK_DELAY_MS_MAX
              value: "8000"
            # Retry webhook delivery on non-2xx (Twilio-like behavior).
            - name: MOCK_WEBHOOK_MAX_RETRIES
              value: "8"
            - name: MOCK_WEBHOOK_RETRY_BASE_MS
              value: "250"
            - name: MOCK_WEBHOOK_RETRY_MAX_MS
              value: "10000"
            - name: MOCK_WEBHOOK_RETRY_JITTER_PCT
              value: "20"
          resources:
            requests:
              cpu: "200m"
              memory: "256Mi"
            limits:
              cpu: "800m"
              memory: "512Mi"
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 65532
            capabilities:
              drop: ["ALL"]
---
apiVersion: v1
kind: Service
metadata:
  name: notif-mock-provider-svc
  labels:
    app: notif-mock-provider
spec:
  type: ClusterIP
  selector:
    app: notif-mock-provider
  ports:
    - name: http
      port: 80
      targetPort: 8080
