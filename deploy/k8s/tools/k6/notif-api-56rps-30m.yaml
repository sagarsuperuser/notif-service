apiVersion: batch/v1
kind: Job
metadata:
  name: k6-notif-api-56rps-30m
spec:
  backoffLimit: 0
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: k6
          image: grafana/k6:latest
          args: ["run", "/scripts/notif-api-56rps-30m.js"]
          env:
            - name: API_URL
              value: "http://notif-api-svc/v1/sms/messages"
          volumeMounts:
            - name: scripts
              mountPath: /scripts
      volumes:
        - name: scripts
          configMap:
            name: k6-notif-api-56rps-30m
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-notif-api-56rps-30m
data:
  notif-api-56rps-30m.js: |
    import http from 'k6/http';
    import { check } from 'k6';
    import exec from 'k6/execution';

    export const options = {
      scenarios: {
        steady_56rps_30m: {
          executor: 'constant-arrival-rate',
          rate: 56,           // ~55.6 rps
          timeUnit: '1s',
          duration: '10m',
          preAllocatedVUs: 80, // start here
          maxVUs: 300,         // headroom if API slows
        },
      },
    };

    const API_URL = __ENV.API_URL || 'http://notif-api-svc/v1/sms/messages';
    const PHONE_POOL_SIZE = 100000;
    const PHONE_PREFIX = '+199900';

    export default function () {
      const now = Date.now();
      const it = exec.scenario.iterationInTest;
      const key = `k6-${it}-${__VU}-${now}`;
      const idx = it % PHONE_POOL_SIZE;
      const to = `${PHONE_PREFIX}${String(idx).padStart(5, '0')}`;

      const payload = JSON.stringify({
        tenantId: 'foodapp',
        idempotencyKey: key,
        to,
        templateId: 'txn_confirm_v1',
        vars: {
          name: 'Test',
          ref: key,
        },
      });

      const params = {
        headers: {
          'Content-Type': 'application/json',
          'X-Test-Run': 'k6-notif-api-56rps-30m',
        },
      };

      const res = http.post(API_URL, payload, params);
      check(res, {
        'status is 2xx': (r) => r.status >= 200 && r.status < 300,
      });
    }
